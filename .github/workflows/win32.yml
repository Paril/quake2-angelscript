name: Win32 Build

on: push

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write

    steps:

    - name: Checkout
      uses: actions/checkout@v3

    - name: Add msbuild to PATH
      uses: microsoft/setup-msbuild@v2
      with:
        msbuild-architecture: x64
    
    - name: Build app for release
      run: msbuild game.sln -t:rebuild -verbosity:diag -property:Configuration=Release

    - name: Copy scripts to build folder
      continue-on-error: true
      run: |
        robocopy ./as/scripts ./build/scripts /E; if ($lastexitcode -lt 8) { $global:LASTEXITCODE = $null }
        Compress-Archive -Path build/* -Destination x64Build.zip

    - name: Release
      uses: softprops/action-gh-release@v2
      if: startsWith(github.ref, 'refs/tags/')
      with:
        name: nightly-release-${{ github.event.repository.updated_at}}
        draft: true
        files: x64Build.zip
